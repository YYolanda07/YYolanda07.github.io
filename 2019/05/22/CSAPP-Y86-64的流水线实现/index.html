<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="author" content="Tan"><meta name="renderer" content="webkit"><meta name="copyright" content="Tan"><meta name="keywords" content="hexo,hexo-theme,hexo-blog"><meta name="description" content="日常学习与兴趣交流的个人博客"><meta http-equiv="Cache-control" content="no-cache"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>CSAPP Y86-64的流水线实现 · Tan&#39;s Blog</title><style type="text/css">@font-face{font-family:Oswald-Regular;src:url(/font/Oswald-Regular.ttf)}body{margin:0}.back-top,.container,.sidebar,.site-intro-meta,.toc-wrapper,footer,header{display:none}.site-intro{position:relative;z-index:3;width:100%;overflow:hidden}.site-intro-placeholder{position:absolute;z-index:-2;top:0;left:0;width:calc(100% + 300px);height:100%;background:repeating-linear-gradient(-45deg,#444 0,#444 80px,#333 80px,#333 160px);background-position:center center;transform:translate3d(-226px,0,0);animation:gradient-move 2.5s ease-out 0s infinite}@keyframes gradient-move{0%{transform:translate3d(-226px,0,0)}100%{transform:translate3d(0,0,0)}}</style><link rel="preload" href="/css/style.css?v=20180824" as="style" onload='this.onload=null,this.rel="stylesheet"'><link rel="stylesheet" href="/css/mobile.css?v=20180824" media="(max-width:980px)"><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload='this.onload=null,this.rel="stylesheet"'><script>!function(n){"use strict";n.loadCSS||(n.loadCSS=function(){});var o=loadCSS.relpreload={};if(o.support=function(){var e;try{e=n.document.createElement("link").relList.supports("preload")}catch(t){e=!1}return function(){return e}}(),o.bindMediaToggle=function(t){var e=t.media||"all";function a(){t.media=e}t.addEventListener?t.addEventListener("load",a):t.attachEvent&&t.attachEvent("onload",a),setTimeout(function(){t.rel="stylesheet",t.media="only x"}),setTimeout(a,3e3)},o.poly=function(){if(!o.support())for(var t=n.document.getElementsByTagName("link"),e=0;e<t.length;e++){var a=t[e];"preload"!==a.rel||"style"!==a.getAttribute("as")||a.getAttribute("data-loadcss")||(a.setAttribute("data-loadcss",!0),o.bindMediaToggle(a))}},!o.support()){o.poly();var t=n.setInterval(o.poly,500);n.addEventListener?n.addEventListener("load",function(){o.poly(),n.clearInterval(t)}):n.attachEvent&&n.attachEvent("onload",function(){o.poly(),n.clearInterval(t)})}"undefined"!=typeof exports?exports.loadCSS=loadCSS:n.loadCSS=loadCSS}("undefined"!=typeof global?global:this)</script><link rel="icon" href="/assets/favicon.ico"><link rel="preload" href="https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" as="script"><link rel="preload" href="/scripts/main.js" as="script"><link rel="preload" as="font" href="/font/Oswald-Regular.ttf" crossorigin><link rel="preload" as="font" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" crossorigin><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script></head><body class="post-body"><header class="header"><div class="read-progress"></div><div class="header-sidebar-menu">&#xe775;</div><div class="banner"><div class="blog-title"><a href="/">Tan&#39;s Blog.</a></div><div class="post-title"><a href="#" class="post-name">CSAPP Y86-64的流水线实现</a></div></div><a class="home-link" href="/">Tan's Blog.</a></header><div class="wrapper"><div class="site-intro" style="height:50vh"><div class="site-intro-placeholder"></div><div class="site-intro-img" style="background-image:url(/intro/post-bg.jpg)"></div><div class="site-intro-meta"><h1 class="intro-title">CSAPP Y86-64的流水线实现</h1><p class="intro-subtitle"></p><div class="post-intros"><div class="post-intro-tags"><a class="post-tag" href="javascript:void(0);" data-tags="深入理解计算机系统">深入理解计算机系统</a></div><div class="post-intro-read"><span>字数统计: <span class="post-count word-count">1.9k</span>阅读时长: <span class="post-count reading-time">6 min</span></span></div><div class="post-intro-meta"><span class="post-intro-calander iconfont-archer">&#xe676;</span> <span class="post-intro-time">2019/05/22</span> <span id="busuanzi_container_page_pv" class="busuanzi-pv"><span class="iconfont-archer">&#xe602;</span> <span id="busuanzi_value_page_pv"></span> </span><span class="shareWrapper"><span class="iconfont-archer shareIcon">&#xe71d;</span> <span class="shareText">Share</span><ul class="shareList"><li class="iconfont-archer share-qr" data-type="qr">&#xe75b;<div class="share-qrcode"></div></li><li class="iconfont-archer" data-type="weibo">&#xe619;</li><li class="iconfont-archer" data-type="qzone">&#xe62e;</li><li class="iconfont-archer" data-type="twitter">&#xe634;</li><li class="iconfont-archer" data-type="facebook">&#xe67a;</li></ul></span></div></div></div></div><script>var browser={versions:function(){var e=window.navigator.userAgent;return{userAgent:e,trident:-1<e.indexOf("Trident"),presto:-1<e.indexOf("Presto"),webKit:-1<e.indexOf("AppleWebKit"),gecko:-1<e.indexOf("Gecko")&&-1==e.indexOf("KHTML"),mobile:!!e.match(/AppleWebKit.*Mobile.*/),ios:!!e.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:-1<e.indexOf("Android")||-1<e.indexOf("Linux"),iPhone:-1<e.indexOf("iPhone")||-1<e.indexOf("Mac"),iPad:-1<e.indexOf("iPad"),webApp:-1==e.indexOf("Safari"),weixin:-1==e.indexOf("MicroMessenger"),uc:-1<e.indexOf("UCBrowser")}}()};function fontLoaded(){if(console.log("font loaded"),document.getElementsByClassName("site-intro-meta")){document.getElementsByClassName("intro-title")[0].classList.add("intro-fade-in"),document.getElementsByClassName("intro-subtitle")[0].classList.add("intro-fade-in");var e=document.getElementsByClassName("post-intros")[0];e&&e.classList.add("post-fade-in")}}function asyncCb(){browser.versions.uc?(console.log("UCBrowser"),fontLoaded()):WebFont.load({custom:{families:["Oswald-Regular"]},loading:function(){},active:function(){fontLoaded()},inactive:function(){console.log("inactive: timeout"),fontLoaded()},timeout:5e3})}function asyncErr(){console.warn("script load from CDN failed, will load local script")}function async(e,n,t){var o=document,i="script",s=o.createElement(i),a=o.getElementsByTagName(i)[0];s.src=e,n&&s.addEventListener("load",function(e){n(null,e)},!1),t&&s.addEventListener("error",function(e){t(null,e)},!1),a.parentNode.insertBefore(s,a)}console.log("userAgent:"+browser.versions.userAgent);var asyncLoadWithFallBack=function(e,n,t){var o=function(){t(),e.shift(),e.length&&async(e[0],n,o)};async(e[0],n,o)};asyncLoadWithFallBack(["https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js","https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js","/lib/webfontloader.min.js"],asyncCb,asyncErr)</script><img class="loading" src="/assets/loading.svg" style="display:block;margin:6rem auto 0 auto;width:6rem;height:6rem"><div class="container container-unloaded"><main class="main post-page"><article class="article-entry"><h2 id="流水线的概述"><a href="#流水线的概述" class="headerlink" title="流水线的概述"></a>流水线的概述</h2><p>简单来说流水线这个概念出现在我们日常生活中，比如餐厅的服务线和自动汽车清洗线都是应用于这个原理。流水线化的一个重要特性就是提高了系统的吞吐量，不过它也会轻微地增加延迟。</p><h2 id="流水线的局限性"><a href="#流水线的局限性" class="headerlink" title="流水线的局限性"></a>流水线的局限性</h2><p>1、不一致的划分<br>之前的是一个理想的流水线化的系统，每个阶段需要的时间都相同。而实际系统通过各阶段的延迟一般是不同的。且运行时钟的速率是由最慢阶段的延迟限制的。<br>2、流水线过深，收益反而下降<br>例如，我们把计算分成6个阶段，每个阶段需要50ps。在每对阶段之间插入流水线寄存器就得到了一个六阶段流水线。这个系统的最小时钟周期为50+20=70ps，吞吐量为14.29GIPS。性能比3阶段流水提高了14.29/8.33=1.71倍。由于通过流水线寄存器的延迟，吞吐量并没有加倍。这个延迟成了流水线吞吐量的一个制约因素。为了提高时钟频率，现代处理器采用了很深的流水线。</p><h2 id="流水线冒险"><a href="#流水线冒险" class="headerlink" title="流水线冒险"></a>流水线冒险</h2><p>使用流水线技术，当相邻指令间存在相关时会导致出现问题。这些相关有：<br>1、数据相关：下一条指令会用到这一条指令计算出的结果<br>2、控制相关：一条指令要确定下一条指令的位置，例如在执行跳转、调用或返回指令时。<br>这些相关可能会导致流水线产生计算错误，称为冒险。</p><h3 id="用暂停来避免数据冒险"><a href="#用暂停来避免数据冒险" class="headerlink" title="用暂停来避免数据冒险"></a>用暂停来避免数据冒险</h3><p>暂停是避免冒险的一种常用技术。让一条指令停顿在译码阶段，直到产生它的源操作数的指令通过了写回阶段，这样我们的处理器就能避免数据冒险。<br>暂停技术就是让一组指令阻塞在它们所处的阶段，而允许其他指令继续通过流水线。</p><h3 id="用转发来避免数据冒险"><a href="#用转发来避免数据冒险" class="headerlink" title="用转发来避免数据冒险"></a>用转发来避免数据冒险</h3><p>在译码阶段从寄存器文件中读入源操作数，但是对这些源寄存器的写有可能要在写回阶段才能进行。与其暂停直到写完成，不如简单地将要写的值传到流水线寄存器E作为源操作数。<br>（即，我们不必等到irmovl $10, %edx和irmovl $3, %eax 完成对寄存器的写更新之后再继续addl，而是在addl译码阶段发现需要%edx、%eax值，译码逻辑不从寄存器文件中去读，而是用前面阶段未写入寄存器的值。）这种将结果直接从一个流水线阶段传到较早阶段的技术称为数据转发。在周期4中，译码阶段逻辑发现有在访存阶段中对寄存器%edx未进行的写，还发现在执行阶段中正在计算寄存器%eax的新值。它用这些值，而不是从寄存器文件中读出的值，作为valA和valB的值。</p><h3 id="加载-使用数据冒险"><a href="#加载-使用数据冒险" class="headerlink" title="加载/使用数据冒险"></a>加载/使用数据冒险</h3><p>有一类数据冒险不能单纯用转发来解决，因为存储器读(访存阶段)在流水线发生的比较晚。<br>我们可以将暂停和转发结合起来，避免加载/使用数据冒险。（既然是来不及发送给后面的指令，那就让后面的指令暂停几个周期，再发送）<br>当mrmovl指令通过执行阶段时，流水线控制逻辑发现译码阶段中的指令(addl)需要从存储器中读出的结果。它会将译码阶段中的addl指令暂停一个周期，导致执行阶段中插入一个气泡。 mrmovl指令从存储器中读出的值可以从访存阶段转发到译码阶段中的addl指令。<br>这种用暂停来处理加载/使用冒险的方法称为加载互锁。加载互锁和转发技术结合起来足以处理所有可能类型的数据冒险。</p><h3 id="避免控制冒险"><a href="#避免控制冒险" class="headerlink" title="避免控制冒险"></a>避免控制冒险</h3><p>在处理器无法根据处于取址阶段的当前指令来确定下一条指令的地址时，就会出现控制冒险，一般来说控制冒险只会出现在ret和跳转指令上。当出现特殊情况时，通过暂停和往流水线中插入气泡的技术可以动态调整流水线的流程。</p><h2 id="分支预测"><a href="#分支预测" class="headerlink" title="分支预测"></a>分支预测</h2><p>流水线化设计的目的就是每个时钟周期都发射一条新指令，要做到这一点，我们必须在取出当前指令之后，马上确定下一条指令的位置。<br>但如果取出的指令是条件分支指令，要到几个周期后，也就是指令通过执行阶段之后，我们才能知道是否要选择分支。类似的，如果取出的指令是ret，要到指令通过访存阶段，才能确定返回地址。<br>对条件转移来说，我们既可以预测选择了分支，那么新PC值应为valC，也可以预测没有选择分支，那么新PC值应为valP。<br>对ret指令，可能的返回值几乎是无限的，因为返回地址位于栈顶的字，其内容可以是任意的。在设计中，我们不会试图对返回地址做任何预测。只是简单地暂停处理新指令，直到ret指令通过写回阶段。<br>无论哪种情况，我们都必须以某种方式来处理预测错误的情况，因为此时已经取出并部分执行了错误的指令。</p><h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><p>异常可以由程序执行从内部产生，也可以由某个外部信号从外部产生。简单的三种内部异常：<br>1、halt指令<br>2、非法指令<br>3、访问非法地址<br>在简化的ISA模型中，当处理器遇到异常时，会停止，设置适当的状态码，且应该是到异常指令之前的所有指令都已经完成，而其后的指令都不应该对程序员可见的状态产生任何影响。在一个更完整的设计中，处理器会继续调用异常处理程序，这是操作系统的一部分。<br>一般地，通过在流水线结构中加入异常处理逻辑，我们会在每个流水线寄存器中包括一个状态码Stat。如果一条指令在其处理器中于某个阶段产生了一个异常，这个状态字段就被设置成指示异常的种类。<br>异常状态和该指令的其他信息一起沿着流水线传播，直到它到达写回阶段。在此，流水线控制逻辑发现了异常，并停止执行。<br>异常事件不会对流水线中的指令流有任何影响，除了会禁止流水线中后面的指令更新程序员的可见状态，直到异常指令到达最后的流水线阶段。<br>因为指令到达写回阶段的顺序与它们在非流水化的处理器中执行的顺序相同，所以我们可以保证第一条遇到异常的指令会第一个到达写回阶段，此时程序执行会停止，流水线寄存器中的状态码会被记录为程序状态。</p></article><div class="license-wrapper"><p>原文作者：<a href="http://yoursite.com">Tan</a></p><p>原文链接：<a href="http://yoursite.com/2019/05/22/CSAPP-Y86-64的流水线实现/">http://yoursite.com/2019/05/22/CSAPP-Y86-64的流水线实现/</a></p><p>发表日期：<a href="http://yoursite.com/2019/05/22/CSAPP-Y86-64的流水线实现/">May 22nd 2019, 5:38:02 pm</a></p><p>更新日期：<a href="http://yoursite.com/2019/05/22/CSAPP-Y86-64的流水线实现/">May 22nd 2019, 7:34:21 pm</a></p><p>版权声明：本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p></div><ul class="post-paginator"><li class="next"></li><li class="previous"><div class="prevSlogan">Previous Post</div><a href="/2019/05/20/CSAPP-Y86-64顺序的实现/" title="CSAPP Y86-64顺序的实现"><div class="prevTitle">CSAPP Y86-64顺序的实现</div></a></li></ul><div id="container"></div><link rel="stylesheet" href="https://billts.site/extra_css/gitment.css"><script src="https://billts.site/js/gitment.js"></script><script>var gitment=new Gitment({id:"Wed May 22 2019 17:38:02 GMT+0800",owner:"yyolanda07",repo:"yyolanda07.github.io",oauth:{client_id:"d898e298dafe04a52b85",client_secret:"b23a2c5c5033bde4d48ba4929ab109a34407d191"}});gitment.render("container")</script></main></div><footer class="footer footer-unloaded"><div class="social"><a href="mailto:12345@qq.com" class="iconfont-archer email" title="email"></a> <a href="//github.com/yyolanda07" class="iconfont-archer github" target="_blank" title="github"></a> <span class="iconfont-archer wechat" title="wechat"><img class="profile-qr" src="/assets/example_qr.png"></span></div><div class="copyright"><span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span></div><div class="busuanzi-container"><span id="busuanzi_container_site_pv">PV: <span id="busuanzi_value_site_pv"></span> :)</span></div></footer></div><div class="toc-wrapper" style="top:50vh"><div class="toc-catalog"><span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#流水线的概述"><span class="toc-number">1.</span> <span class="toc-text">流水线的概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#流水线的局限性"><span class="toc-number">2.</span> <span class="toc-text">流水线的局限性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#流水线冒险"><span class="toc-number">3.</span> <span class="toc-text">流水线冒险</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#用暂停来避免数据冒险"><span class="toc-number">3.1.</span> <span class="toc-text">用暂停来避免数据冒险</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#用转发来避免数据冒险"><span class="toc-number">3.2.</span> <span class="toc-text">用转发来避免数据冒险</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#加载-使用数据冒险"><span class="toc-number">3.3.</span> <span class="toc-text">加载/使用数据冒险</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#避免控制冒险"><span class="toc-number">3.4.</span> <span class="toc-text">避免控制冒险</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分支预测"><span class="toc-number">4.</span> <span class="toc-text">分支预测</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#异常处理"><span class="toc-number">5.</span> <span class="toc-text">异常处理</span></a></li></ol></div><div class="back-top iconfont-archer">&#xe639;</div><div class="sidebar sidebar-hide"><ul class="sidebar-tabs sidebar-tabs-active-0"><li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li><li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li><li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li></ul><div class="sidebar-content sidebar-content-show-archive"><div class="sidebar-panel-archives"><div class="total-and-search"><div class="total-archive">Total : 6</div></div><div class="post-archive"><div class="archive-year">2019</div><ul class="year-list"><li class="archive-post-item"><span class="archive-post-date">05/22</span><a class="archive-post-title" href="/2019/05/22/CSAPP-Y86-64的流水线实现/">CSAPP Y86-64的流水线实现</a></li><li class="archive-post-item"><span class="archive-post-date">05/20</span><a class="archive-post-title" href="/2019/05/20/CSAPP-Y86-64顺序的实现/">CSAPP Y86-64顺序的实现</a></li><li class="archive-post-item"><span class="archive-post-date">05/18</span><a class="archive-post-title" href="/2019/05/18/CSAPP逻辑设计/">CSAPP逻辑设计</a></li><li class="archive-post-item"><span class="archive-post-date">05/17</span><a class="archive-post-title" href="/2019/05/17/CSAPP浮点数操作/">CSAPP浮点数操作</a></li><li class="archive-post-item"><span class="archive-post-date">05/15</span><a class="archive-post-title" href="/2019/05/15/CSAPP数据结构/">CSAPP数据结构</a></li><li class="archive-post-item"><span class="archive-post-date">05/13</span><a class="archive-post-title" href="/2019/05/13/CSAPP过程的实现/">CSAPP过程的实现</a></li></ul></div></div><div class="sidebar-panel-tags"><div class="sidebar-tags-name"><span class="sidebar-tag-name" data-tags="深入理解计算机系统"><span class="iconfont-archer">&#xe606;</span>深入理解计算机系统</span></div><div class="iconfont-archer sidebar-tags-empty">&#xe678;</div><div class="tag-load-fail" style="display:none;color:#ccc;font-size:.6rem">缺失模块。<br>1、请确保node版本大于6.2<br>2、在博客根目录（注意不是archer根目录）执行以下命令：<br><span style="color:#f75357;font-size:1rem;line-height:2rem">npm i hexo-generator-json-content --save</span><br>3、在根目录_config.yml里添加配置：<pre style="color:#787878;font-size:.6rem">
jsonContent:
  meta: false
  pages: false
  posts:
    title: true
    date: true
    path: true
    text: false
    raw: false
    content: false
    slug: false
    updated: false
    comments: false
    link: false
    permalink: false
    excerpt: false
    categories: true
    tags: true</pre></div><div class="sidebar-tags-list"></div></div><div class="sidebar-panel-categories"><div class="sidebar-categories-name"></div><div class="iconfont-archer sidebar-categories-empty">&#xe678;</div><div class="sidebar-categories-list"></div></div></div></div><script>var siteMeta={root:"/",author:"Tan"}</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script type="text/javascript">void 0===window.$&&(console.warn("jquery load from jsdelivr failed, will load local script"),document.write('<script src="/lib/jquery.min.js"><\/script>'))</script><script src="/scripts/main.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/scripts/share.js" async></script></body></html>